<!-- Container Utama -->
<div id="app-container" class="bg-slate-950 text-slate-100 font-sans antialiased min-h-screen flex flex-col overflow-hidden relative">

    <!-- Header -->
    <header class="bg-slate-900 border-b border-slate-800 px-6 py-4 flex items-center justify-between">
        <div class="flex items-center gap-4">
            <h1 class="text-xl font-bold text-white flex items-center gap-2">
                <!-- Icon Mic SVG Manual (Tanpa Lucide Script external agar lebih cepat) -->
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>
                <span class="hidden sm:inline">Panel Pengirim</span>
            </h1>
        </div>
        <div id="connection-status" class="text-xs text-slate-500 font-mono">Connecting...</div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col items-center justify-center p-4">
        <div class="bg-slate-900 border border-slate-800 rounded-3xl shadow-2xl p-6 w-full max-w-lg text-center relative z-10">
            
            <!-- Status Message Area -->
            <div id="status-area" class="hidden mb-6 p-4 rounded-xl border text-left flex items-start gap-3 text-sm">
                <span id="status-text" class="block break-words font-medium"></span>
            </div>

            <!-- Timer & Label -->
            <div class="mb-8">
                <h2 id="action-label" class="text-2xl sm:text-3xl font-bold text-white mb-2">Siapkan Suara</h2>
                <p id="timer" class="text-slate-400 font-mono text-xl">0:00</p>
            </div>

            <!-- Main Button -->
            <div class="flex justify-center mb-10 relative">
                <!-- Ping Animation Ring -->
                <div id="ping-ring" class="hidden absolute inset-0 bg-red-500/20 rounded-full animate-ping"></div>
                
                <button id="record-btn" type="button" class="relative z-20 w-32 h-32 sm:w-36 sm:h-36 rounded-full flex items-center justify-center transition-all duration-300 shadow-xl border-4 bg-blue-600 border-blue-800 hover:scale-105 active:scale-95 group">
                    <!-- Icons (SVG Inline untuk performa) -->
                    <span id="icon-mic">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>
                    </span>
                    <span id="icon-stop" class="hidden">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="white" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/></svg>
                    </span>
                    <span id="icon-loading" class="hidden animate-spin">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>
                    </span>
                </button>
            </div>
            
            <p class="text-xs text-slate-500 italic">
                Klik tombol untuk mulai/stop perekaman.
            </p>
        </div>
    </main>
</div>

<!-- Scripts Loader -->
<script src="https://cdn.tailwindcss.com"></script>
<script>
    tailwind.config = {
        theme: { extend: { colors: { brand: { 900: '#0c4a6e' } } } }
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
// --- SCOPE ISOLATION (IIFE) ---
// Ini mencegah error "Identifier has already been declared"
(function() {
    // --- KONFIGURASI ---
    const CONFIG = {
        URL: 'https://qbfvjbdcdgminlvfcfwb.supabase.co',
        KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFiZnZqYmRjZGdtaW5sdmZjZndiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1NzM3NzUsImV4cCI6MjA4NjE0OTc3NX0.ZEIwxvVJfJvSr6cu-tw7JXCcJ8VBg04WgffwG8GSZok'
    };

    // Variables
    let _client = null;
    let isRecording = false;
    let isUploading = false;
    let mediaRecorder = null;
    let audioChunks = [];
    let timerInterval = null;
    let recordingDuration = 0;

    // Elements
    const els = {
        btn: document.getElementById('record-btn'),
        label: document.getElementById('action-label'),
        timer: document.getElementById('timer'),
        status: document.getElementById('status-area'),
        statusText: document.getElementById('status-text'),
        conn: document.getElementById('connection-status'),
        ping: document.getElementById('ping-ring'),
        icons: {
            mic: document.getElementById('icon-mic'),
            stop: document.getElementById('icon-stop'),
            load: document.getElementById('icon-loading')
        }
    };

    // --- MAIN INIT ---
    async function initApp() {
        if (!window.supabase) {
            setTimeout(initApp, 500); // Tunggu library load
            return;
        }

        try {
            // Create Client (Local Scope)
            _client = window.supabase.createClient(CONFIG.URL, CONFIG.KEY);

            // Auth Check
            const { data: { session } } = await _client.auth.getSession();
            if (!session) {
                // Ignore "disabled" error specifically
                const { error } = await _client.auth.signInAnonymously();
                if (error && !error.message.includes("disabled")) {
                    console.warn("Auth warning:", error.message);
                }
            }
            
            els.conn.innerText = "Siap";
            els.conn.classList.add("text-green-500");
            
            // Attach Event
            // Hapus listener lama jika ada (untuk safety di google sites)
            const newBtn = els.btn.cloneNode(true);
            els.btn.parentNode.replaceChild(newBtn, els.btn);
            els.btn = newBtn; // Update referensi
            els.btn.addEventListener('click', handleClick);

        } catch (e) {
            console.error("Init Error:", e);
            els.conn.innerText = "Error";
            els.conn.classList.add("text-red-500");
        }
    }

    // --- LOGIC ---
    function handleClick() {
        if (isUploading) return;
        if (isRecording) stopRecording();
        else startRecording();
    }

    async function startRecording() {
        hideStatus();
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];

            mediaRecorder.ondataavailable = e => {
                if (e.data.size > 0) audioChunks.push(e.data);
            };

            mediaRecorder.onstop = uploadRecording;
            mediaRecorder.start();
            
            isRecording = true;
            updateUI();
            startTimer();

        } catch (err) {
            console.error(err);
            if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                showStatus('error', 'IZIN DITOLAK: Google Sites memblokir mikrofon. Solusi: Buka aplikasi ini di tab baru (pop-up) atau host di Vercel/Netlify.');
            } else {
                showStatus('error', 'Gagal akses mic: ' + err.message);
            }
        }
    }

    function stopRecording() {
        if (mediaRecorder && isRecording) {
            mediaRecorder.stop();
            isRecording = false;
            mediaRecorder.stream.getTracks().forEach(track => track.stop());
            clearInterval(timerInterval);
            updateUI();
        }
    }

    function startTimer() {
        recordingDuration = 0;
        els.timer.innerText = "0:00";
        timerInterval = setInterval(() => {
            recordingDuration++;
            const m = Math.floor(recordingDuration / 60);
            const s = (recordingDuration % 60).toString().padStart(2, '0');
            els.timer.innerText = `${m}:${s}`;
        }, 1000);
    }

    async function uploadRecording() {
        isUploading = true;
        updateUI();
        showStatus('info', 'Sedang mengirim...');

        try {
            const blob = new Blob(audioChunks, { type: 'audio/webm' });
            const fileName = `broadcast-${Date.now()}.webm`;

            // 1. Upload
            const { error: upErr } = await _client.storage
                .from('audio_broadcasts')
                .upload(fileName, blob, { contentType: 'audio/webm' });

            if (upErr) throw new Error("Upload Gagal: " + upErr.message);

            // 2. Get URL
            const { data: urlData } = _client.storage
                .from('audio_broadcasts')
                .getPublicUrl(fileName);

            // 3. Insert DB
            const { error: dbErr } = await _client
                .from('broadcasts')
                .insert({
                    audio_url: urlData.publicUrl,
                    status: 'pending',
                    title: 'Pesan Suara Web',
                    sender_email: 'google-sites-user'
                });

            if (dbErr) throw new Error("Database Gagal: " + dbErr.message);

            showStatus('success', 'Berhasil terkirim!');

        } catch (err) {
            showStatus('error', err.message);
        } finally {
            isUploading = false;
            updateUI();
        }
    }

    // --- UI HELPERS ---
    function updateUI() {
        // Hide all icons
        els.icons.mic.classList.add('hidden');
        els.icons.stop.classList.add('hidden');
        els.icons.load.classList.add('hidden');
        els.ping.classList.add('hidden');
        
        // Reset btn classes
        els.btn.className = "relative z-20 w-32 h-32 sm:w-36 sm:h-36 rounded-full flex items-center justify-center transition-all duration-300 shadow-xl border-4";

        if (isUploading) {
            els.btn.classList.add('bg-slate-800', 'border-slate-700', 'cursor-not-allowed');
            els.icons.load.classList.remove('hidden');
            els.label.innerText = "Mengirim...";
        } else if (isRecording) {
            els.btn.classList.add('bg-red-600', 'border-red-800', 'scale-95');
            els.icons.stop.classList.remove('hidden');
            els.ping.classList.remove('hidden');
            els.label.innerText = "Merekam...";
        } else {
            els.btn.classList.add('bg-blue-600', 'border-blue-800', 'hover:scale-105');
            els.icons.mic.classList.remove('hidden');
            els.label.innerText = "Klik Bicara";
        }
    }

    function showStatus(type, msg) {
        els.status.classList.remove('hidden', 'bg-red-500/20', 'text-red-300', 'bg-green-500/20', 'text-green-300', 'bg-blue-500/20', 'text-blue-300');
        
        if (type === 'error') els.status.classList.add('bg-red-500/20', 'text-red-300');
        else if (type === 'success') els.status.classList.add('bg-green-500/20', 'text-green-300');
        else els.status.classList.add('bg-blue-500/20', 'text-blue-300');

        els.statusText.innerText = msg;
    }

    function hideStatus() {
        els.status.classList.add('hidden');
    }

    // Jalankan Init
    initApp();

})(); 
</script>